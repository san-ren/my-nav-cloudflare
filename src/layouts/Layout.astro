---
import { ClientRouter } from 'astro:transitions'; 
import '../styles/global.css'; 
import '../styles/theme.css';  
import '../styles/animations.css'; 

const { title } = Astro.props;
const base = '/my-nav';
---

<!doctype html>
<html lang="zh-CN" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    
    <ClientRouter />
    
    <script is:inline>
      // 封装初始化逻辑，方便复用
      function initTheme() {
        try {
          const root = document.documentElement;
          const localStorage = window.localStorage;

          // 1. 恢复主题色 (HEX 转 RGB)
          // 对应 ThemePicker 中的 brand-color 逻辑
          const savedColor = localStorage.getItem('brand-color');
          if (savedColor) {
            const r = parseInt(savedColor.slice(1, 3), 16);
            const g = parseInt(savedColor.slice(3, 5), 16);
            const b = parseInt(savedColor.slice(5, 7), 16);
            root.style.setProperty('--color-brand-rgb', `${r} ${g} ${b}`);
          } else {
            // 默认颜色 #4F46E5 (Indigo-600)
            root.style.setProperty('--color-brand-rgb', '79 70 229');
          }

          // 2. 恢复亮/暗模式
          const savedTheme = localStorage.getItem('theme') || 'auto';
          if (savedTheme === 'auto') {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
              root.classList.add('dark');
            } else {
              root.classList.remove('dark');
            }
          } else {
            root.classList.toggle('dark', savedTheme === 'dark');
          }

          // 3. 恢复背景模糊度
          const savedBlur = localStorage.getItem('bg-blur') || '0';
          root.style.setProperty('--bg-blur', `${savedBlur}px`);

          // 4. 恢复动画偏好
          const savedAnim = localStorage.getItem('site-anim') || 'fade-up';
          root.setAttribute('data-anim', savedAnim);

          // 5. 恢复背景图片 (如果有缓存的 URL)
          // 注意：真正的图片加载涉及 IndexedDB 是异步的，这里只检查 CSS 变量是否残留
          // 实际的图片恢复逻辑由 ThemePicker 或独立的 UI 脚本在 body 底部执行
        } catch (e) {
          console.error('Theme init failed:', e);
        }
      }

      // 立即执行 (阻塞)
      initTheme();

      // 监听 Astro 页面切换 (View Transitions)
      document.addEventListener('astro:after-swap', initTheme);
    </script>
  </head>
  
  <body class="bg-slate-50 dark:bg-[#0b0f1a] transition-colors duration-500 overflow-x-hidden w-full">
    
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
      <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] rounded-full bg-blue-400/10 dark:bg-blue-600/5 blur-[100px]"></div>
      <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] rounded-full bg-purple-400/10 dark:bg-purple-600/5 blur-[100px]"></div>
    </div>

    <slot />

    <script src="../scripts/ui-layout.js"></script>
  </body>
</html>

<style is:global>
  html, body {
    overflow-x: hidden;
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }
  
  html.overflow-hidden,
  body.overflow-hidden {
    overflow: hidden !important;
    height: 100vh !important;
    touch-action: none;
  }
</style>